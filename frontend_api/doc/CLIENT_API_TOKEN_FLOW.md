# Полный флоу выдачи токенов и ограничений запросов для Client API

## 1. Создание токена через Platform API

### Эндпоинт: `POST /auth/client-tokens/create/`

**Аутентификация:** JWT токен (Platform API)

**Запрос:**
```json
{
  "name": "Production API"
}
```

**Процесс:**
1. Пользователь аутентифицирован через JWT токен Platform API
2. Проверяется, что у пользователя меньше 5 активных токенов (валидация в модели `ClientAPIToken`)
3. Генерируется новый токен:
   - `full_token` - полный токен (64 символа, `secrets.token_urlsafe(48)`)
   - `token_hash` - SHA256 хеш токена (хранится в БД)
   - `token_prefix` - первые 8 символов (для отображения)
4. Токен сохраняется в БД с полем `is_active=True`
5. Полный токен возвращается **только один раз** при создании

**Ответ (201):**
```json
{
  "success": true,
  "data": {
    "id": 1,
    "name": "Production API",
    "token": "abc123...полный_токен_64_символа",
    "token_prefix": "abc12345",
    "created_at": "2024-12-03T10:30:00Z",
    "is_active": true,
    "warning": "Save this token now. You will not be able to see it again."
  },
  "message": "Token created successfully"
}
```

**Ошибки:**
- `TOKEN_LIMIT_EXCEEDED` (400) - у пользователя уже 5 активных токенов
- `MISSING_NAME` (400) - не указано имя токена

---

## 2. Получение списка токенов

### Эндпоинт: `GET /auth/client-tokens/`

**Аутентификация:** JWT токен (Platform API)

**Ответ (200):**

**Для пользователя без группы:**
```json
{
  "success": true,
  "data": {
    "tokens": [
      {
        "id": 1,
        "name": "Production API",
        "token_prefix": "abc12345",
        "created_at": "2024-12-03T10:30:00Z",
        "last_used_at": "2024-12-03T15:20:00Z",
        "is_active": true
      }
    ],
    "tokens_count": 1,
    "tokens_available": 4,
    "max_tokens": 5
  },
  "access": {
    "type": "paid",
    "is_paid": true,
    "limit": 500,
    "current_count": 150,
    "remaining": 350,
    "is_group_access": false,
    "group": null,
    "note": "Эта информация относится только к Client API. Для Platform API (JWT токены) ограничений на запросы нет."
  }
}
```

**Для пользователя в группе:**
```json
{
  "success": true,
  "data": {
    "tokens": [
      {
        "id": 1,
        "name": "Production API",
        "token_prefix": "abc12345",
        "created_at": "2024-12-03T10:30:00Z",
        "last_used_at": "2024-12-03T15:20:00Z",
        "is_active": true
      }
    ],
    "tokens_count": 1,
    "tokens_available": 4,
    "max_tokens": 5
  },
  "access": {
    "type": "free",
    "is_paid": false,
    "limit": 100,
    "current_count": 70,
    "remaining": 30,
    "is_group_access": true,
    "group": {
      "id": 1,
      "name": "My Fund",
      "slug": "my-fund"
    },
    "note": "Эта информация относится только к Client API. Для Platform API (JWT токены) ограничений на запросы нет. Лимит запросов общий для всех участников группы."
  }
}
```

**Поля в `access`:**
- `is_group_access` (boolean) - `true` если лимит применяется к группе, `false` если к пользователю
- `group` (object|null) - информация о группе (id, name, slug), если `is_group_access = true`
- `current_count` - текущее количество использованных запросов (общее для группы, если `is_group_access = true`)
- `remaining` - оставшиеся запросы (общие для группы, если `is_group_access = true`)

**Примечание:** Полный токен **не возвращается** в списке, только префикс.

---

## 3. Удаление токена

### Эндпоинт: `DELETE /auth/client-tokens/<token_id>/delete/`

**Аутентификация:** JWT токен (Platform API)

**Процесс:**
1. Токен полностью удаляется из базы данных
2. После удаления токен нельзя использовать для аутентификации

**Ответ (200):**
```json
{
  "success": true,
  "message": "Token has been successfully deleted."
}
```

---

## 4. Использование токена в Client API

### Аутентификация

**Заголовок:**
```
Authorization: Token <полный_токен>
```

**Процесс аутентификации (`ClientAPITokenAuthentication`):**
1. Извлекается токен из заголовка `Authorization: Token <token>`
2. Токен хешируется через `ClientAPIToken.hash_token(token)` (SHA256)
3. Ищется токен в БД по хешу с `is_active=True`
4. Проверяется валидность токена (`is_valid()`)
5. Обновляется `last_used_at` в БД
6. Возвращается `(user, api_token)` для дальнейшего использования

**Ошибки:**
- `Invalid token.` - токен не найден или неактивен
- `Token is expired or inactive.` - токен невалиден

---

## 5. Ограничения запросов (Throttling)

### Логика определения лимита

**Определение типа доступа:**
1. Если у пользователя есть группа (`user.group`):
   - Лимит применяется **на группу** (общий для всех участников)
   - Флаг `is_paid` берется из `user.group.is_paid`
2. Если группы нет:
   - Лимит применяется **на пользователя** (личный лимит)
   - Флаг `is_paid` берется из `user.is_paid`

**Типы лимитов:**

#### Оплаченный доступ (`is_paid=True`)
- **Лимит:** `CLIENT_API_DAILY_RATE_LIMIT` (по умолчанию 500 запросов в день)
- **Хранение:** Кеш (Django cache)
- **Ключ кеша:** `throttle_daily_group_{group_id}_{date}` или `throttle_daily_user_{user_id}_{date}`
- **Время жизни кеша:** 25 часов
- **Логика:** Счетчик запросов за последние 24 часа, сбрасывается каждый день в 00:00

#### Бесплатный доступ (`is_paid=False`)
- **Лимит:** `FREE_CLIENT_LIMIT` (по умолчанию 100 запросов **всего**, не дневное)
- **Хранение:** База данных (`FreeUserRequestCounter`)
- **Ключ:** `group_{group_id}` или `user_{user_id}` (без даты)
- **Логика:** Общий счетчик запросов, **не сбрасывается** (персистентный)
- **При присоединении к группе:** Счетчик пользователя переносится в счетчик группы (запросы добавляются к счетчику группы, счетчик пользователя удаляется)

---

## 6. Процесс проверки лимита запросов

### Для оплаченных пользователей

1. **Генерация ключа кеша:**
   ```
   throttle_daily_group_{group_id}_{today_date}
   или
   throttle_daily_user_{user_id}_{today_date}
   ```

2. **Получение истории запросов из кеша:**
   ```python
   history = cache.get(key, [])
   ```

3. **Фильтрация запросов за последние 24 часа:**
   ```python
   cutoff = now - timedelta(days=1)
   history = [h for h in history if h > cutoff]
   ```

4. **Проверка лимита:**
   - Если `len(history) >= limit` → лимит превышен
   - Если `len(history) < limit` → добавляем текущий запрос в историю

5. **Сохранение в кеш:**
   ```python
   history.append(now)
   cache.set(key, history, 25 * 60 * 60)  # 25 часов
   ```

### Для бесплатных пользователей

1. **Атомарное обновление счетчика в БД:**
   ```python
   with transaction.atomic():
       counter = FreeUserRequestCounter.objects.select_for_update().get_or_create(
           group=user.group,  # или user=user
           defaults={'request_count': 0}
       )[0]
       
       if counter.request_count >= limit:
           return False  # Лимит превышен
       
       counter.request_count += 1
       counter.save()
   ```

2. **Fallback на кеш** (если БД недоступна):
   - Используется кеш с ключом без даты
   - Время жизни: 1 год (365 дней)

---

## 7. Обработка превышения лимита

### Для оплаченных пользователей

**Ответ (429):**
```json
{
  "error": "throttled",
  "message": "Daily request limit exceeded. Limit: 500 requests per day.",
  "details": {
    "limit": 500,
    "wait_seconds": 86400
  }
}
```

**`wait_seconds`** - время до начала следующего дня (00:00)

### Для бесплатных пользователей

**Ответ (429):**
```json
{
  "error": "throttled",
  "message": "Total request limit exceeded. Limit: 100 requests total.",
  "details": {
    "limit": 100
  }
}
```

**Примечание:** Для бесплатных нет `wait_seconds`, так как лимит общий и не сбрасывается.

---

## 8. Настройки в `settings.py`

```python
# Лимит запросов в сутки для Client API (оплаченные аккаунты)
CLIENT_API_DAILY_RATE_LIMIT = 500  # 500 запросов в сутки

# Общий лимит запросов для Client API (бесплатные аккаунты)
FREE_CLIENT_LIMIT = 100  # 100 запросов всего (не дневное)
```

---

## 9. Схема работы

```
┌─────────────────────────────────────────────────────────────┐
│ 1. Создание токена (Platform API)                           │
│    POST /auth/client-tokens/create/                         │
│    → Генерация токена                                       │
│    → Сохранение хеша в БД                                   │
│    → Возврат полного токена (один раз)                      │
└─────────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────────┐
│ 2. Использование токена (Client API)                       │
│    Authorization: Token <token>                              │
│    → Хеширование токена                                     │
│    → Поиск в БД по хешу                                     │
│    → Проверка is_active=True                                 │
│    → Обновление last_used_at                                │
└─────────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────────┐
│ 3. Проверка лимита запросов                                  │
│                                                               │
│    Оплаченный (is_paid=True):                                │
│    → Кеш: throttle_daily_{ident}_{date}                      │
│    → Фильтр: запросы за последние 24 часа                    │
│    → Лимит: 500/день                                         │
│                                                               │
│    Бесплатный (is_paid=False):                                │
│    → БД: FreeUserRequestCounter                              │
│    → Атомарное увеличение счетчика                           │
│    → Лимит: 100 всего (не сбрасывается)                      │
└─────────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────────┐
│ 4. Обработка запроса                                         │
│    → Если лимит не превышен: выполнение запроса               │
│    → Если лимит превышен: 429 Throttled                      │
└─────────────────────────────────────────────────────────────┘
```

---

## 10. Привязка токенов и переход на оплату

### Привязка токенов

**Токены привязаны к пользователю**, а не к группе:
- `ClientAPIToken.user` - ForeignKey к `User`
- Токены работают независимо от наличия группы
- Токены работают независимо от статуса оплаты (`is_paid`)

**Важно:** При изменении группы или статуса оплаты токены **не нужно пересоздавать** - они продолжают работать.

### Переход на оплату

**Для пользователя без группы:**
1. Изменить `user.is_paid = True`
2. **Менять группу не нужно**
3. Лимит автоматически меняется:
   - Было: 100 запросов всего (бесплатный)
   - Стало: 500 запросов в день (оплаченный)
4. Счетчик бесплатных запросов (`FreeUserRequestCounter` для пользователя) **автоматически удаляется**

**Для группы:**
1. Изменить `group.is_paid = True`
2. Лимит меняется для **всех участников группы**:
   - Было: 100 запросов всего (бесплатный, общий для группы)
   - Стало: 500 запросов в день (оплаченный, общий для группы)
3. Счетчик бесплатных запросов группы (`FreeUserRequestCounter` для группы) **автоматически удаляется**

**Логика определения типа доступа:**
```python
if user.group:
    is_paid = user.group.is_paid  # Берется из группы
else:
    is_paid = user.is_paid  # Берется из пользователя
```

---

## 11. Присоединение пользователя к группе

### Для бесплатных пользователей

**Сценарий:** Пользователь без группы использовал 50 запросов из 100, затем присоединился к группе.

**Процесс:**
1. При сохранении пользователя с новой группой срабатывает сигнал `handle_user_group_change`
2. Система проверяет наличие счетчика пользователя (`FreeUserRequestCounter` с `user=user`)
3. Если счетчик существует и `request_count > 0`:
   - Получается или создается счетчик группы (`FreeUserRequestCounter` с `group=group`)
   - Значение счетчика пользователя **добавляется** к счетчику группы:
     ```python
     group_counter.request_count += user_counter.request_count
     ```
   - Счетчик пользователя **удаляется** из БД
4. Дальнейшие запросы учитываются в счетчике группы

**Пример:**
- Пользователь использовал 50 запросов (счетчик: `user_123` = 50)
- Группа уже использовала 30 запросов (счетчик: `group_456` = 30)
- После присоединения: счетчик группы = 50 + 30 = 80 запросов
- Осталось: 100 - 80 = 20 запросов

**Важно:**
- Запросы пользователя **не теряются** - они переносятся в группу
- Если группа уже использовала лимит, пользователь сразу получает ограничение
- Если пользователь покидает группу, счетчик группы остается (не переносится обратно)

### Для оплаченных пользователей

Для оплаченных пользователей счетчики хранятся в кеше с датой, поэтому при присоединении к группе:
- Старый счетчик пользователя автоматически истекает через 25 часов
- Начинается новый счетчик группы с текущей даты
- Запросы пользователя не переносятся (дневной лимит сбрасывается каждый день)

---

## 12. Важные моменты

1. **Полный токен показывается только при создании** - после этого доступен только префикс
2. **Максимум 5 активных токенов** на пользователя
3. **Лимит для группы** - если пользователь в группе, лимит общий для всех участников
4. **Персистентность для бесплатных** - счетчик хранится в БД и не сбрасывается
5. **Дневной лимит для платных** - счетчик сбрасывается каждый день в 00:00
6. **Атомарность обновлений** - для бесплатных используется `select_for_update()` для предотвращения race conditions (см. раздел ниже)
7. **Перенос счетчика при присоединении к группе** - для бесплатных запросы пользователя добавляются к счетчику группы

